#set shared dictionary
lua_shared_dict conf 10m;


server {
  listen       80;
  index  index_dev.php;
  server_name web.dev.woshimaijia.com;
  location / {
    include fastcgi_params;
    fastcgi_intercept_errors on;
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index index_dev.php;
    fastcgi_param SCRIPT_FILENAME  /source/restybuddy/Presentation/Web/$fastcgi_script_name;
    root /source/restybuddy/Presentation/Web;
    if (!-e $request_filename){
       rewrite ^/(.*) /index_dev.php/$1 break;
    }
  }

  log_format  web.dev.woshimaijia.com  '$remote_addr - $remote_user [$time_local] $request '
    '$status $body_bytes_sent $http_referer '
    '$http_user_agent $http_x_forwarded_for';
  access_log  /source/restybuddy/Log/web.dev.woshimaijia.com.log  web.dev.woshimaijia.com;


}


server {
  listen       80;
  index index_dev.php;
  server_name api.dev.woshimaijia.com;

  encrypted_session_key "abcdefghijklmnopqrstuvwyxq123456";
  encrypted_session_iv "1234567888845678";
  encrypted_session_expires 86400;

  location /encrypt {
    set $id '1334568798768232';
    set_encrypt_session $session $id;
    set_encode_base32 $session;
    add_header Set-Cookie 'wsmjlogin=$session';
    echo "$session";
  }

  location /decrypt {
    set_decode_base32 $session $cookie_wsmjlogin;
    set_decrypt_session $id $session;

    if ($id = '') {
        # bad session handler here ...
        echo "decrypt session";
    }
    #my content handler goes here ...
    echo $id;  #then do other moudle
  }

  location /uuid {
    content_by_lua_file conf/vhosts/library/uuid.lua;
  }

  location ~ '^/api(.*)' {
    content_by_lua_file conf/vhosts/library/common.lua;
  }

  location ~ '^/redis(.*)' {
    content_by_lua_file conf/vhosts/library/redis.lua;
  }

 # location =/upload {
 #   content_by_lua_file conf/vhosts/library/upload.lua;
 # }

  location / {  
    include fastcgi_params;
    fastcgi_intercept_errors on;
    fastcgi_pass   127.0.0.1:9000;
    fastcgi_index  index_dev.php;
    fastcgi_param  SCRIPT_FILENAME  /source/restybuddy/Presentation/Api/$fastcgi_script_name;
    root   /source/restybuddy/Presentation/Api;
    if (!-e $request_filename){
      rewrite ^/(.*) /index_dev.php/$1 break;
    }   
  }

  log_format  api.dev.woshimaijia.com  '$remote_addr - $remote_user [$time_local] $request '
    '$status $body_bytes_sent $http_referer '
    '$http_user_agent $http_x_forwarded_for';
  access_log  /source/restybuddy/Log/api.dev.woshimaijia.com.log  api.dev.woshimaijia.com;


}

server {
  listen       80;
  index index_dev.php;
  server_name mis.dev.woshimaijia.com;

  location =/reloadconf {
      content_by_lua_file conf/vhosts/library/reloadconf.lua;
  }

  location =/getconf {
    content_by_lua_file conf/vhosts/library/getconf.lua;
  }

  location / { 
    include fastcgi_params;
    fastcgi_intercept_errors on;
    fastcgi_pass   127.0.0.1:9000;
    fastcgi_index  index_dev.php;
    fastcgi_param  SCRIPT_FILENAME  /source/restybuddy/Presentation/Mis/$fastcgi_script_name;
    root   /source/restybuddy/Presentation/Mis;
    if (!-e $request_filename){
      rewrite ^/(.*) /index_dev.php/$1 break;
    }   
  }

   log_format  mis.dev.woshimaijia.com  '$remote_addr - $remote_user [$time_local] $request '
    '$status $body_bytes_sent $http_referer '
    '$http_user_agent $http_x_forwarded_for';
   access_log  /source/restybuddy/Log/mis.dev.woshimaijia.com.log  mis.dev.woshimaijia.com;

}


server {
  listen       80;
  server_name static.dev.woshimaijia.com;
  index index.html index.htm index_dev.php default.html default.htm default.php;
  root  /source/restybuddy/Presentation/Static/;
  error_page 404 = /404.html;
  location ~ .*\.(php|php5)?$
  {
    fastcgi_pass  127.0.0.1:9000;
    fastcgi_index index_dev.php;
    include fastcgi_params;
  }

  location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
  {
    expires      30d;
  }

  location ~ .*\.(js|css)?$
  {
    expires      12h;
  }

  log_format  static.dev.woshimaijia.com  '$remote_addr - $remote_user [$time_local] $request '
    '$status $body_bytes_sent $http_referer '
    '$http_user_agent $http_x_forwarded_for';
  access_log  /source/restybuddy/Log/static.dev.woshimaijia.com.log  static.dev.woshimaijia.com;
}

server {
  listen       80;
  server_name img.dev.woshimaijia.com;
  index index.html index.htm index_dev.php default.html default.htm default.php;
  root  /source/restybuddy/Presentation/Image;
  error_page 404 = /404.html;

  location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
  {
    expires      30d;
  }

  location ~ .*\.(js|css)?$
  {
    expires      12h;
  }

  log_format  img.dev.woshimaijia.com  '$remote_addr - $remote_user [$time_local] $request '
    '$status $body_bytes_sent $http_referer '
    '$http_user_agent $http_x_forwarded_for';
  access_log  /source/restybuddy/Log/img.dev.woshimaijia.com.log  img.dev.woshimaijia.com;
}



server {
  listen       80;
  server_name test.dev.woshimaijia.com;
  index index.html index.htm index.php default.html default.htm default.php;
  root  /source/restybuddy/Presentation/Test;
  error_page 404 = /404.html;
  
  location ~ .*\.(php)?$ {
    include fastcgi_params;
    fastcgi_intercept_errors on;
    fastcgi_pass 127.0.0.1:9000;
    fastcgi_index index_dev.php;
    fastcgi_param SCRIPT_FILENAME  /source/restybuddy/Presentation/Web/$fastcgi_script_name;
    root /source/restybuddy/Presentation/Web;
    if (!-e $request_filename){
       rewrite ^/(.*) /index_dev.php/$1 break;
    }
 }


  location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$
  {
    expires      30d;
  }

  location ~ .*\.(js|css)?$
  {
    expires      12h;
  }

  log_format  test.dev.woshimaijia.com  '$remote_addr - $remote_user [$time_local] $request '
    '$status $body_bytes_sent $http_referer '
    '$http_user_agent $http_x_forwarded_for';
  access_log  /source/restybuddy/Log/test.dev.woshimaijia.com.log  test.dev.woshimaijia.com;
}



